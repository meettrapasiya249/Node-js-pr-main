<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web view â€“ categories</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{
            --primary:#0d6efd;
            --muted:#6c757d;
            --bg:#f5f7fb;
            --card:#ffffff;
            --radius:16px;
            --soft-shadow:0 12px 30px rgba(0,10,30,0.05);
        }
        *,*::before,*::after{box-sizing:border-box}
        body { 
            margin:0;
            background: var(--bg); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            color:#1a2634;
        }
        .web-menu { 
            background:var(--card); 
            padding:10px 20px; 
            border-radius: 40px;
            border: 1px solid rgba(255,255,255,0.7);
            position: sticky; 
            top:16px; 
            z-index:50;
            box-shadow: 0 8px 22px rgba(0,20,40,0.06);
            margin:16px 20px 20px 20px;
            backdrop-filter: blur(4px);
            background: rgba(255,255,255,0.85);
        }
        .web-menu .container { 
            display:flex; 
            gap:14px; 
            align-items:center; 
            flex-wrap:wrap;
            max-width: 1300px;
            margin: 0 auto;
            padding:0 4px;
        }
        .web-menu .cat-btn{ 
            padding:8px 20px; 
            border-radius:40px; 
            border:1px solid #dee4ec; 
            background:#fff; 
            color:#2c3e50; 
            text-decoration:none;
            font-size:0.95rem;
            font-weight:500;
            transition: all 0.2s ease;
            display: inline-block;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        .web-menu .cat-btn:hover {
            background: #f2f5f9;
            border-color: #b3c2d1;
            color: #0d6efd;
            transform: translateY(-2px);
        }
        .web-menu .cat-btn.active{ 
            background:var(--primary); 
            color:#fff; 
            border-color:var(--primary);
            box-shadow: 0 6px 12px rgba(13,110,253,0.2);
        }
        .container { 
            padding: 16px 20px 32px; 
            max-width: 1300px;
            margin: 0 auto;
        }
        /* 3â€‘card grid system */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -12px;
            gap: 24px 0;
        }
        .col-12 { flex: 0 0 100%; max-width:100%; padding:0 12px; }
        .col-md-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
            padding: 0 12px;
        }
        .product-card { 
            border-radius: 24px; 
            overflow: hidden; 
            box-shadow: var(--soft-shadow); 
            background:var(--card);
            transition: transform 0.25s ease, box-shadow 0.3s ease;
            border: 1px solid #ffffff70;
            backdrop-filter: blur(2px);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .product-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 24px 44px -8px rgba(13,110,253,0.15);
            border-color: #fff;
        }
        .product-image { 
            height: 210px; 
            object-fit: cover; 
            width: 100%; 
            display:block;
            background: linear-gradient(145deg, #f0f4fa, #e9ecf3);
            transition: transform .5s ease;
            border-bottom: 1px solid #f0f3f8;
        }
        .product-card:hover .product-image{ transform: scale(1.03) }
        .card-body {
            padding: 20px 20px 22px;
            flex: 1;
        }
        .card-title { 
            font-weight: 700; 
            color: #0b1c2f;
            margin-bottom: 18px;
            font-size: 1.45rem;
            letter-spacing: -0.01em;
            border-bottom: 2px solid #f0f4fc;
            padding-bottom: 10px;
        }
        .badge { 
            margin-right: 6px; 
            margin-bottom: 8px;
            background:#fff3d8; 
            color:#7a6300; 
            border-radius:100px; 
            padding:6px 16px; 
            font-size:0.8rem;
            font-weight: 500;
            display: inline-block;
            border: 1px solid #ffe194;
            box-shadow: 0 2px 4px #ffd96630;
        }
        .meta { 
            color: var(--muted); 
            font-size:0.9rem;
        }
        .admin-btn { 
            margin-left: auto; 
            padding:9px 24px; 
            border-radius:40px; 
            background:var(--primary); 
            color:#fff; 
            text-decoration:none; 
            border:1px solid rgba(13,110,253,0.95);
            font-weight: 600;
            font-size:0.95rem;
            transition: all 0.18s ease;
            display:inline-block;
            box-shadow: 0 8px 14px -8px #0d6efd70;
        }
        .admin-btn:hover {
            background: #0b5ed7;
            border-color: #0a58ca;
            color: #fff;
            transform: scale(1.02);
        }
        /* Add product modal */
        #addProductModal { display: none; position: fixed; inset: 0; background: rgba(10,20,30,0.6); align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(6px); }
        #addProductModal .modal-card { background: #fff; width: 760px; max-width: 96%; border-radius: 32px; padding: 28px; box-shadow: 0 30px 60px rgba(0,20,40,0.3); border: 1px solid #ffffff50; }
        #addProductModal label { font-weight:600; display:block; margin-bottom:6px; color:#1f2c3a; font-size:0.95rem;}
        #addProductModal .form-control { width:100%; padding:12px 16px; border-radius:18px; border:1px solid #dbe3ed; background:#f9fcff; font-size:0.95rem; transition:0.15s;}
        #addProductModal .form-control:focus { border-color:var(--primary); outline:none; box-shadow:0 0 0 3px #0d6efd30;}
        #addProductModal .form-row { display:flex; gap:16px; flex-wrap:wrap }
        #addProductModal .form-col { flex:1 1 48%; min-width:200px }
        #addProductModal .form-actions { display:flex; gap:12px; justify-content:flex-end; margin-top:28px }
        #addProductModal .btn-cancel { background:#6c757d; border-color:#5a6268; box-shadow:none; }
        .alert {
            padding: 20px 28px;
            border-radius: 30px;
            background: #e3f0ff;
            color: #00467a;
            border: 1px solid #b8dafe;
            font-weight: 500;
        }
        .alert-info { background: #e3f0ff; color: #00467a; }
        .text-muted { color: #6c757d; font-size: 0.95rem; font-style: italic; }
        h2 {
            font-weight: 700;
            color: #142433;
            letter-spacing: -0.02em;
            margin-top: 8px;
            font-size: 2rem;
        }
        .subgroup {
            background: #fafcff;
            border-radius: 20px;
            padding: 14px 14px 8px 14px;
            margin-bottom: 16px;
            border: 1px solid #eef3fc;
            transition: 0.1s;
        }
        .subgroup strong {
            color: #1a2b3c;
            font-size: 1.05rem;
            display: block;
            margin-bottom: 8px;
            font-weight: 650;
        }
        .badge-warning {
            background: #fff8e7;
            color: #966909;
        }
        .back-link{ display:inline-block; color:var(--primary); text-decoration:underline; margin-top:12px }
        /* mobile */
        @media (max-width: 992px) {
            .col-md-4 { flex: 0 0 50%; max-width:50%; }
        }
        @media (max-width: 700px) {
            .col-md-4 { flex: 0 0 100%; max-width:100%; }
            .web-menu { margin: 8px 12px; border-radius: 28px; }
            .web-menu .container { gap: 8px; }
            .admin-btn { margin-left: 0; width: 100%; text-align: center; margin-top: 6px; }
        }
        /* cart dropdown */
        #webCartDropdown { border: 1px solid #eef2f7; border-radius: 24px; padding: 16px; min-width: 280px; }
        .remove-item { font-size: 0.85rem; background: #fee; padding: 4px 10px; border-radius: 40px; color:#b02a37; font-weight:500; border:1px solid #ffc6c6; transition:0.15s; }
        .remove-item:hover { background:#fcc; }
        
        /* cart page specific styles */
        .cart-container { max-width: 1100px; margin: 2rem auto; }
        .cart-item-row { display: flex; align-items: center; gap: 20px; background: white; border-radius: 40px; padding: 15px 25px; margin-bottom: 16px; box-shadow: 0 4px 14px #e9ecf5; border:1px solid #edf2f9; }
        .cart-item-details { flex:1; }
        .cart-price { font-weight: 700; color:#0d6efd; font-size:1.3rem; }
        .cart-qty { background: #eef4ff; padding: 5px 15px; border-radius: 40px; }
        .btn-outline-danger { background: #ffe6e6; border: 1px solid #ffb3b3; color:#b02a37; border-radius: 40px; padding:6px 18px; font-weight:500; cursor:pointer; }
        .btn-outline-danger:hover { background:#ffc9c9; }
    </style>
</head>
<body>
    <!-- top bar -->
    <div class="web-menu">
        <div class="container">
            <div style="display:flex; align-items:center; gap:20px; flex-wrap:wrap; width:100%;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <strong style="color:#253544;">Categories:</strong>
                    <a href="/web" class="cat-btn <%= !selected ? 'active' : '' %>">All</a>
                    <% if (categories && categories.length) { %>
                        <% categories.forEach((cat) => { %>
                            <a href="/web?category=<%= cat._id %>" class="cat-btn <%= selected && String(selected._id)===String(cat._id) ? 'active' : '' %>"><%= cat.categoryName %></a>
                        <% }) %>
                    <% } %>
                </div>
                <div style="display:flex; gap:10px; align-items:center; margin-left:auto;">
                    <% if (typeof currentAdmin !== 'undefined' && currentAdmin) { %>
                        <button id="openAddProduct" class="admin-btn" style="background:#28a745;border-color:#28a745;">+ Add Product</button>
                    <% } %>
                    <a href="/admin/view-admin" class="admin-btn" style="background:#1e2a36;border-color:#1e2a36;">Admin Panel</a>
                    <span style="position:relative;">
                        <button id="webCartToggle" style="background:transparent;border:none;cursor:pointer;font-size:20px;padding:8px 12px; background:#f0f4fe; border-radius:40px;">
                            <i class="fas fa-shopping-cart" style="color:#0d6efd;"></i>
                        </button>
                        <span id="webCartCount" style="position:absolute; top:-4px; right:-2px; background:#dc3545; color:#fff; font-size:11px; font-weight:600; padding:3px 8px; border-radius:999px;">0</span>
                        <div id="webCartDropdown" style="display:none; position:absolute; right:0; margin-top:14px; background:#fff; border-radius:28px; box-shadow:0 16px 36px rgba(0,0,0,0.15); padding:18px; min-width:300px; z-index:120; border:1px solid #eaeef5;">
                            <div id="webCartItems"><div class="text-muted">Loading cart...</div></div>
                            <div style="text-align:right; margin-top:16px;"><a href="/cart" class="admin-btn" style="background:#0d6efd;border-color:#0d6efd;">Go to Cart</a></div>
                        </div>
                    </span>
                </div>
            </div>
        </div>
    </div> 

    <!-- Add Product Modal -->
    <div id="addProductModal">
        <div class="modal-card">
            <h4 style="margin-top:0; font-size:1.8rem; font-weight:650;">Add to cart</h4>
            <form id="addProductForm">
                <div class="form-row">
                    <div class="form-col" style="flex:1 1 100%;">
                        <label>Product Name</label>
                        <input name="productName" class="form-control" required />
                    </div>
                    <div class="form-col">
                        <label>Category</label>
                        <select id="ap_category" name="categoryId" class="form-control" required>
                            <option value="" disabled selected>Select category</option>
                            <% if (categories && categories.length) { %>
                                <% categories.forEach(cat => { %>
                                    <option value="<%= cat._id %>"><%= cat.categoryName %></option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Subcategory</label>
                        <select id="ap_subcategory" name="subcategoryId" class="form-control" required disabled>
                            <option value="" disabled selected>Select category first</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>ExtraCategory</label>
                        <select id="ap_extracategory" name="extracategoryId" class="form-control" required disabled>
                            <option value="" disabled selected>Select subcategory first</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Price</label>
                        <input type="number" step="0.01" name="price" class="form-control" required />
                    </div>
                    <div class="form-col">
                        <label>Quantity</label>
                        <input type="number" name="qty" class="form-control" value="1" min="1" required />
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" id="ap_cancel" class="admin-btn btn-cancel">Cancel</button>
                    <button type="submit" class="admin-btn" style="background:#0d6efd;">Add to Cart</button>
                </div>
            </form>
        </div>
    </div>

    <!-- REGULAR CATEGORIES VIEW (3 cards per row) -->
    <div class="container">
        <% if (selected) { %>
            <!-- detailed single category -->
            <h2 class="mb-4"><%= selected.categoryName %></h2>
            <div class="row">
                <div class="col-12">
                    <div class="product-card mb-4">
                        <% if (selected.profileImg) { %>
                            <img src="/uploads/<%= selected.profileImg %>" class="product-image" alt="<%= selected.categoryName %>">
                        <% } else { %>
                            <img src="https://via.placeholder.com/600x300/dfe7f5/3a4b5e?text=Category" class="product-image">
                        <% } %>
                        <div class="card-body">
                            <h4 class="card-title"><%= selected.categoryName %></h4>
                            <% if (selected.subcategories && selected.subcategories.length) { %>
                                <% selected.subcategories.forEach((sc) => { %>
                                    <div class="subgroup">
                                        <strong><%= sc.subcategoryName %></strong>
                                        <% const extras = selected.extracategories ? selected.extracategories.filter(e => String(e.subcategoryId) === String(sc._id)) : [] %>
                                        <% if (extras && extras.length) { %>
                                            <div>
                                                <% extras.forEach((ex) => { %>
                                                    <span class="badge badge-warning"><%= ex.extracategoryName %></span>
                                                <% }) %>
                                            </div>
                                        <% } else { %>
                                            <span class="meta">No extras</span>
                                        <% } %>
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <p class="text-muted">No subcategories</p>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        <% } else { %>
            <h2 class="mb-4">âœ¨ All Categories</h2>
            <% if (categories && categories.length > 0) { %>
                <div class="row">
                    <% categories.forEach((category) => { %>
                        <div class="col-md-4">
                            <div class="product-card h-100">
                                <% if (category.profileImg) { %>
                                    <img src="/uploads/<%= category.profileImg %>" class="product-image" alt="<%= category.categoryName %>">
                                <% } else { %>
                                    <img src="https://via.placeholder.com/500x280/e9ecf5/33475b?text=<%= category.categoryName %>" class="product-image">
                                <% } %>
                                <div class="card-body">
                                    <h5 class="card-title"><%= category.categoryName %></h5>
                                    <% if (category.subcategories && category.subcategories.length > 0) { %>
                                        <% category.subcategories.slice(0,3).forEach((sc) => { %>
                                            <div class="subgroup" style="padding:10px 12px;">
                                                <strong style="font-size:0.95rem;"><%= sc.subcategoryName %></strong>
                                                <% const extras = category.extracategories ? category.extracategories.filter(e => String(e.subcategoryId) === String(sc._id)) : [] %>
                                                <% if (extras && extras.length > 0) { %>
                                                    <div style="margin-top:6px;">
                                                        <% extras.slice(0,3).forEach((ex) => { %>
                                                            <span class="badge"><%= ex.extracategoryName %></span>
                                                        <% }) %>
                                                        <% if(extras.length>3){ %> <span class="badge">+<%= extras.length-3 %></span> <% } %>
                                                    </div>
                                                <% } %>
                                            </div>
                                        <% }) %>
                                        <% if(category.subcategories.length > 3){ %>
                                            <span class="meta">+ <%= category.subcategories.length-3 %> more</span>
                                        <% } %>
                                    <% } else { %>
                                        <p class="text-muted">No subcategories</p>
                                    <% } %>
                                    <div class="mt-4">
                                        <a href="/web/category/<%= category._id %>" class="admin-btn" style="background:#0d6efd; padding:8px 22px;">View details</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="alert alert-info">âœ¨ No categories yet â€” add some in admin panel.</div>
            <% } %>
        <% } %>
    </div> 

    <!-- footer include -->
    <%- include('footer') %> 

    <!-- global cart update script (for mini cart) -->
    <script>
        (function() {
            // Modal open/close
            const openAddProduct = document.getElementById('openAddProduct')
            const addProductModal = document.getElementById('addProductModal')
            const ap_cancel = document.getElementById('ap_cancel')
            if (openAddProduct) openAddProduct.addEventListener('click', () => addProductModal.style.display = 'flex')
            if (ap_cancel) ap_cancel.addEventListener('click', () => addProductModal.style.display = 'none')

            const ap_category = document.getElementById('ap_category')
            const ap_subcategory = document.getElementById('ap_subcategory')
            const ap_extracategory = document.getElementById('ap_extracategory')

            if (ap_category) {
                ap_category.addEventListener('change', async function(){
                    const cid = this.value
                    ap_subcategory.innerHTML = '<option disabled selected>Loading...</option>'
                    ap_subcategory.disabled = true
                    try {
                        const res = await fetch(`/extracategory/get-subcategories/${cid}`)
                        const subs = await res.json()
                        ap_subcategory.innerHTML = '<option value="" disabled selected>Select subcategory</option>'
                        subs.forEach(s => {
                            const o = document.createElement('option')
                            o.value = s._id; o.textContent = s.subcategoryName
                            ap_subcategory.appendChild(o)
                        })
                        ap_subcategory.disabled = false
                    } catch (e) {
                        ap_subcategory.innerHTML = '<option disabled selected>Error</option>'
                    }
                })
            }

            if (ap_subcategory) {
                ap_subcategory.addEventListener('change', async function(){
                    const sid = this.value
                    ap_extracategory.innerHTML = '<option disabled selected>Loading...</option>'
                    ap_extracategory.disabled = true
                    try {
                        const res = await fetch(`/extracategory/get-by-subcategory/${sid}`)
                        const extras = await res.json()
                        ap_extracategory.innerHTML = '<option value="" disabled selected>Select extra</option>'
                        extras.forEach(ex => {
                            const o = document.createElement('option')
                            o.value = ex._id; o.textContent = ex.extracategoryName
                            ap_extracategory.appendChild(o)
                        })
                        ap_extracategory.disabled = false
                    } catch (e) {
                        ap_extracategory.innerHTML = '<option disabled selected>Error</option>'
                    }
                })
            }

            const addProductForm = document.getElementById('addProductForm')
            if (addProductForm) {
                addProductForm.addEventListener('submit', async function(e){
                    e.preventDefault()
                    const form = new FormData(addProductForm)
                    const payload = {}
                    form.forEach((v,k)=>payload[k]=v)
                    const catOpt = ap_category.options[ap_category.selectedIndex]
                    const subOpt = ap_subcategory.options[ap_subcategory.selectedIndex]
                    const exOpt = ap_extracategory.options[ap_extracategory.selectedIndex]
                    payload.categoryName = catOpt ? catOpt.text : ''
                    payload.subcategoryName = subOpt ? subOpt.text : ''
                    payload.extracategoryName = exOpt ? exOpt.text : ''

                    try {
                        // FIXED: Use /api/cart/add instead of /cart/add
                        const res = await fetch('/api/cart/add', {
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify(payload)
                        })
                        const data = await res.json()
                        if (data.success) {
                            addProductModal.style.display = 'none'
                            fetchCartAndUpdate()
                            alert('âœ… Added to cart')
                        } else alert('Failed')
                    } catch (err) { 
                        console.error(err); 
                        alert('Error adding to cart') 
                    }
                })
            }

            // Mini cart update function - FIXED: Use /api/cart
            window.fetchCartAndUpdate = async function() {
                try {
                    const res = await fetch('/api/cart')
                    const data = await res.json()
                    const items = data.cart || []
                    const count = items.reduce((s,i)=>s+i.qty,0)
                    const webCartCount = document.getElementById('webCartCount')
                    if (webCartCount) webCartCount.textContent = count

                    const webCartItems = document.getElementById('webCartItems')
                    if (!webCartItems) return

                    if (!items.length) {
                        webCartItems.innerHTML = '<div class="text-muted">ðŸ›’ Cart is empty</div>'
                        return
                    }

                    webCartItems.innerHTML = ''
                    items.forEach(it => {
                        const div = document.createElement('div')
                        div.style.display = 'flex'
                        div.style.justifyContent = 'space-between'
                        div.style.marginBottom = '12px'
                        div.style.borderBottom = '1px solid #f0f2f5'
                        div.style.paddingBottom = '8px'
                        div.innerHTML = `
                            <div>
                                <strong>${it.productName}</strong>
                                <div class="meta" style="font-size:0.8rem;">${it.categoryName || ''} â€º ${it.subcategoryName || ''} â€º ${it.extracategoryName || ''}</div>
                            </div>
                            <div style="text-align:right">
                                <div>â‚¹ ${it.price?.toFixed(2)}</div>
                                <div><button data-id="${it.id}" class="remove-item" style="background:#fdd; border:none;border-radius:40px;padding:3px 10px;cursor:pointer;">Remove</button></div>
                            </div>
                        `
                        webCartItems.appendChild(div)
                    })

                    document.querySelectorAll('.remove-item').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const id = this.dataset.id
                            // FIXED: Use /api/cart/remove
                            await fetch('/api/cart/remove', {
                                method: 'POST',
                                headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({id})
                            })
                            fetchCartAndUpdate()
                        })
                    })
                } catch (e) {
                    console.error('Mini cart error:', e)
                }
            }

            fetchCartAndUpdate()

            // Cart dropdown toggle
            const webCartToggle = document.getElementById('webCartToggle')
            const webCartDropdown = document.getElementById('webCartDropdown')
            if (webCartToggle && webCartDropdown) {
                webCartToggle.addEventListener('click', (e) => {
                    e.stopPropagation()
                    webCartDropdown.style.display = webCartDropdown.style.display === 'block' ? 'none' : 'block'
                })
                document.addEventListener('click', (ev) => {
                    if (!webCartDropdown.contains(ev.target) && ev.target !== webCartToggle) {
                        webCartDropdown.style.display = 'none'
                    }
                })
            }
        })()
    </script>
</body>
</html>